     1                                      BOOT_LOAD    equ    0x7C00  ; „Éñ„Éº„Éà„Éó„É≠„Ç∞„É©„É†„ÅÆ„É≠„Éº„Éâ‰ΩçÁΩÆ
     2                                  
     3                                      ORG    BOOT_LOAD            ; „É≠„Éº„Éâ„Ç¢„Éâ„É¨„Çπ„Çí„Ç¢„Çª„É≥„Éñ„É©„Å´ÊåáÁ§∫
     4                                  
     5                                  ; „Éû„ÇØ„É≠
     6                                  %include    "../include/macro.s"
     1                              <1> %macro  cdecl 1-*.nolist
     2                              <1> 
     3                              <1>     %rep    %0 - 1
     4                              <1>         push    %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate -1
     8                              <1>     call    %1
     9                              <1> 
    10                              <1>     %if 1 < %0
    11                              <1>         add sp, (__BITS__ >> 3) * (%0 - 1)
    12                              <1>     %endif
    13                              <1> 
    14                              <1> %endmacro
     7                                  
     8                                  ; „Ç®„É≥„Éà„É™„Éù„Ç§„É≥„Éà
     9                                  entry:
    10                                      ; BPB (BIOS Parameter Block)
    11 00000000 EB58                        jmp     ipl
    12 00000002 90<rept>                    times   90 - ($ -$$) db 0x90
    13                                  
    14                                      ; IPL (Initial Program Loader)
    15                                  
    16                                  ipl:
    17 0000005A FA                          cli                         ; Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢
    18                                  
    19 0000005B B80000                      mov     ax, 0x0000
    20 0000005E 8ED8                        mov     ds, ax
    21 00000060 8EC0                        mov     es, ax
    22 00000062 8ED0                        mov     ss, ax
    23 00000064 BC007C                      mov     sp, BOOT_LOAD
    24                                  
    25 00000067 FB                          sti                         ; Ââ≤„ÇäËæº„ÅøË®±ÂèØ
    26                                  
    27 00000068 8816[4A01]                  mov     [BOOT.DRIVE], dl
    28                                  
    29                                      ; ÊñáÂ≠óÂàó„ÇíË°®Á§∫
    30 0000006C 68[3001]E8DA0083C4-         cdecl   puts,   .s0
    30 00000074 02                 
    31                                  
    32                                      ; Êï∞ÂÄ§„ÇíË°®Á§∫
    33 00000075 6A016A0A6A0868-             cdecl   itoa,   8086,   .s1,    8,  10,     0b0001      ; "8086"
    33 0000007C [3D01]68961FE8E700-
    33 00000084 83C40A             
    34 00000087 68[3D01]E8BF0083C4-         cdecl   puts,   .s1
    34 0000008F 02                 
    35                                  
    36 00000090 6A036A0A6A0868-             cdecl   itoa,   8086,   .s1,    8,  10,     0b0011      ; "+8086"
    36 00000097 [3D01]68961FE8CC00-
    36 0000009F 83C40A             
    37 000000A2 68[3D01]E8A40083C4-         cdecl   puts,   .s1
    37 000000AA 02                 
    38                                  
    39 000000AB 6A016A0A6A0868-             cdecl   itoa,   -8086,  .s1,    8,  10,     0b0001      ; "-8086"
    39 000000B2 [3D01]686AE0E8B100-
    39 000000BA 83C40A             
    40 000000BD 68[3D01]E8890083C4-         cdecl   puts,   .s1
    40 000000C5 02                 
    41                                  
    42 000000C6 6A016A0A6A0868-             cdecl   itoa,   -1,     .s1,    8,  10,     0b0001      ; "-1"
    42 000000CD [3D01]6AFFE8970083-
    42 000000D5 C40A               
    43 000000D7 68[3D01]E86F0083C4-         cdecl   puts,   .s1
    43 000000DF 02                 
    44                                  
    45 000000E0 6A006A0A6A0868-             cdecl   itoa,   -1,     .s1,    8,  10,     0b0000      ; "65535"
    45 000000E7 [3D01]6AFFE87D0083-
    45 000000EF C40A               
    46 000000F1 68[3D01]E8550083C4-         cdecl   puts,   .s1
    46 000000F9 02                 
    47                                  
    48 000000FA 6A006A106A0868-             cdecl   itoa,   -1,     .s1,    8,  16,     0b0000      ; "FFFF"
    48 00000101 [3D01]6AFFE8630083-
    48 00000109 C40A               
    49 0000010B 68[3D01]E83B0083C4-         cdecl   puts,   .s1
    49 00000113 02                 
    50                                  
    51 00000114 6A046A026A0868-             cdecl   itoa,   12,     .s1,    8,  2,      0b0100      ; "00001100"
    51 0000011B [3D01]6A0CE8490083-
    51 00000123 C40A               
    52 00000125 68[3D01]E8210083C4-         cdecl   puts,   .s1
    52 0000012D 02                 
    53                                  
    54 0000012E EBFE                        jmp     $               ; while(1) ; ÁÑ°Èôê„É´„Éº„Éó
    55                                  
    56                                      ; „Éá„Éº„Çø
    57 00000130 426F6F74696E672E2E-     .s0 db "Booting...", 0x0A, 0x0D, 0
    57 00000139 2E0A0D00           
    58 0000013D 2D2D2D2D2D2D2D2D2D-     .s1 db "----------", 0x0A, 0x0D, 0
    58 00000146 2D0A0D00           
    59                                  
    60                                  ALIGN 2, db 0
    61                                  BOOT:
    62 0000014A 0000                    .DRIVE: dw 0
    63                                  
    64                                  ; „É¢„Ç∏„É•„Éº„É´
    65                                  %include    "../modules/real/puts.s"
     1                              <1> puts:
     2                              <1>     ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ
     3 0000014C 55                  <1>     push    bp  ; bp + 4: ÊñáÂ≠óÂàó„Å∏„ÅÆ„Ç¢„Éâ„É¨„Çπ
     4 0000014D 89E5                <1>     mov     bp, sp
     5                              <1> 
     6                              <1>     ; „É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò
     7 0000014F 50                  <1>     push    ax
     8 00000150 53                  <1>     push    bx
     9 00000151 56                  <1>     push    si
    10                              <1> 
    11                              <1>     ; ÂºïÊï∞„ÇíÂèñÂæó
    12 00000152 8B7604              <1>     mov     si, [bp + 4]  ; ÊñáÂ≠óÂàó„Å∏„ÅÆ„Ç¢„Éâ„É¨„Çπ„Çí SI „Å´„Çª„ÉÉ„Éà„ÄÇ
    13                              <1> 
    14                              <1>     ; Âá¶ÁêÜ„ÅÆÈñãÂßã
    15 00000155 B40E                <1>     mov     ah, 0x0E
    16 00000157 BB0000              <1>     mov     bx, 0x0000
    17 0000015A FC                  <1>     cld
    18                              <1> .10L:
    19 0000015B AC                  <1>     lodsb  ; Load String. 'b' stands for byte.
    20                              <1> 
    21 0000015C 3C00                <1>     cmp     al, 0
    22 0000015E 7404                <1>     je      .10E
    23                              <1> 
    24 00000160 CD10                <1>     int     0x10
    25 00000162 EBF7                <1>     jmp     .10L
    26                              <1> .10E:
    27                              <1> 
    28                              <1>     ; „É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞
    29 00000164 5E                  <1>     pop     si
    30 00000165 5B                  <1>     pop     bx
    31 00000166 58                  <1>     pop     ax
    32                              <1> 
    33                              <1>     ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ
    34 00000167 89EC                <1>     mov     sp, bp
    35 00000169 5D                  <1>     pop     bp
    36                              <1> 
    37 0000016A C3                  <1>     ret
    66                                  %include    "../modules/real/itoa.s"
     1                              <1> itoa:
     2                              <1>         ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ
     3 0000016B 55                  <1>         push    bp
     4 0000016C 89E5                <1>         mov     bp, sp
     5                              <1> 
     6                              <1>         ; „É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò
     7 0000016E 50                  <1>         push    ax
     8 0000016F 53                  <1>         push    bx
     9 00000170 51                  <1>         push    cx
    10 00000171 52                  <1>         push    dx
    11 00000172 56                  <1>         push    si
    12 00000173 57                  <1>         push    di
    13                              <1> 
    14                              <1>         ; ÂºïÊï∞„ÇíÂèñÂæó
    15 00000174 8B4604              <1>         mov     ax, [bp + 4]
    16 00000177 8B7606              <1>         mov     si, [bp + 6]
    17 0000017A 8B4E08              <1>         mov     cx, [bp + 8]
    18                              <1> 
    19 0000017D 89F7                <1>         mov     di, si
    20 0000017F 01CF                <1>         add     di, cx
    21 00000181 4F                  <1>         dec     di
    22                              <1> 
    23 00000182 8B5E0C              <1>         mov     bx, word [bp + 12]
    24                              <1> 
    25                              <1>         ; Á¨¶Âè∑‰ªò„ÅçÂà§ÂÆö
    26 00000185 F7C30100            <1>         test    bx, 0b0001
    27 00000189 7408                <1> .10Q:   je  .10E
    28 0000018B 83F800              <1>         cmp ax, 0
    29 0000018E 7D03                <1> .12Q:   jge .12E
    30 00000190 83CB02              <1>         or  bx, 0b0010
    31                              <1> .12E:
    32                              <1> .10E:
    33                              <1> 
    34                              <1>         ; Á¨¶Âè∑Âá∫ÂäõÂà§ÂÆö
    35 00000193 F7C30200            <1>         test    bx, 0b0010
    36 00000197 7410                <1> .20Q:   je  .20E
    37 00000199 83F800              <1>         cmp ax, 0
    38 0000019C 7D07                <1> .22Q:   jge .22F
    39 0000019E F7D8                <1>         neg ax
    40 000001A0 C6042D              <1>         mov [si], byte  '-'
    41 000001A3 EB03                <1>         jmp .22E
    42                              <1> .22F:
    43 000001A5 C6042B              <1>         mov [si], byte  '+'
    44                              <1> .22E:
    45 000001A8 49                  <1>         dec cx
    46                              <1> .20E:
    47                              <1> 
    48                              <1>         ; ASCII Â§âÊèõ
    49 000001A9 8B5E0A              <1>         mov     bx, [bp + 10]
    50                              <1> .30L:
    51 000001AC BA0000              <1>         mov     dx, 0
    52 000001AF F7F3                <1>         div     bx
    53                              <1> 
    54 000001B1 89D6                <1>         mov     si, dx
    55 000001B3 8A94[DB01]          <1>         mov     dl, byte [.ascii + si]
    56                              <1> 
    57 000001B7 8815                <1>         mov     [di], dl
    58 000001B9 4F                  <1>         dec     di
    59                              <1> 
    60 000001BA 83F800              <1>         cmp     ax, 0
    61 000001BD E0ED                <1>         loopnz  .30L
    62                              <1> .30E:
    63                              <1> 
    64                              <1>         ; Á©∫Ê¨Ñ„ÇíÂüã„ÇÅ„Çã
    65 000001BF 83F900              <1>         cmp     cx, 0
    66 000001C2 740D                <1> .40Q:   je      .40E
    67 000001C4 B020                <1>         mov     al, ' '
    68 000001C6 837E0C04            <1>         cmp     [bp +12], word 0b0100
    69 000001CA 7502                <1> .42Q:   jne     .42E
    70 000001CC B030                <1>         mov     al, '0'
    71                              <1> .42E:
    72 000001CE FD                  <1>         std
    73 000001CF F3AA                <1>         rep stosb
    74                              <1> .40E:
    75                              <1> 
    76                              <1>         ; „É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞
    77 000001D1 5F                  <1>         pop     di
    78 000001D2 5E                  <1>         pop     si
    79 000001D3 5A                  <1>         pop     dx
    80 000001D4 59                  <1>         pop     cx
    81 000001D5 5B                  <1>         pop     bx
    82 000001D6 58                  <1>         pop     ax
    83                              <1> 
    84                              <1>         ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ
    85 000001D7 89EC                <1>         mov     sp, bp
    86 000001D9 5D                  <1>         pop     bp
    87                              <1> 
    88 000001DA C3                  <1>         ret
    89                              <1> 
    90 000001DB 303132333435363738- <1> .ascii  db      "0123456789ABCDEF"
    90 000001E4 39414243444546      <1>
    67                                  
    68 000001EB 00<rept>                    times    510 - ($ - $$) db 0x00
    69 000001FE 55AA                        db 0x55, 0xAA
