     1                                      BOOT_LOAD    equ    0x7C00  ; „Éñ„Éº„Éà„Éó„É≠„Ç∞„É©„É†„ÅÆ„É≠„Éº„Éâ‰ΩçÁΩÆ
     2                                  
     3                                      ORG    BOOT_LOAD            ; „É≠„Éº„Éâ„Ç¢„Éâ„É¨„Çπ„Çí„Ç¢„Çª„É≥„Éñ„É©„Å´ÊåáÁ§∫
     4                                  
     5                                  ; „Éû„ÇØ„É≠
     6                                  %include    "../include/macro.s"
     1                              <1> %macro  cdecl 1-*.nolist
     2                              <1> 
     3                              <1>     %rep    %0 - 1
     4                              <1>         push    %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate -1
     8                              <1>     call    %1
     9                              <1> 
    10                              <1>     %if 1 < %0
    11                              <1>         add sp, (__BITS__ >> 3) * (%0 - 1)
    12                              <1>     %endif
    13                              <1> 
    14                              <1> %endmacro
     7                                  
     8                                  ; „Ç®„É≥„Éà„É™„Éù„Ç§„É≥„Éà
     9                                  entry:
    10                                      ; BPB (BIOS Parameter Block)
    11 00000000 EB58                        jmp     ipl
    12 00000002 90<rept>                    times   90 - ($ -$$) db 0x90
    13                                  
    14                                      ; IPL (Initial Program Loader)
    15                                  
    16                                  ipl:
    17 0000005A FA                          cli                         ; Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢
    18                                  
    19 0000005B B80000                      mov     ax, 0x0000
    20 0000005E 8ED8                        mov     ds, ax
    21 00000060 8EC0                        mov     es, ax
    22 00000062 8ED0                        mov     ss, ax
    23 00000064 BC007C                      mov     sp, BOOT_LOAD
    24                                  
    25 00000067 FB                          sti                         ; Ââ≤„ÇäËæº„ÅøË®±ÂèØ
    26                                  
    27 00000068 8816[0001]                  mov     [BOOT.DRIVE], dl
    28                                  
    29                                      ; ÊñáÂ≠óÂàó„ÇíË°®Á§∫
    30 0000006C 68[E500]E8900083C4-         cdecl   puts,   .s0
    30 00000074 02                 
    31                                  
    32 00000075 E82901                      cdecl   reboot
    33                                  
    34                                      ; Êï∞ÂÄ§„ÇíË°®Á§∫
    35 00000078 6A016A0A6A0868-             cdecl   itoa,   8086,   .s1,    8,  10,     0b0001      ; "8086"
    35 0000007F [F200]68961FE89A00-
    35 00000087 83C40A             
    36 0000008A 68[F200]E8720083C4-         cdecl   puts,   .s1
    36 00000092 02                 
    37                                  
    38 00000093 6A036A0A6A0868-             cdecl   itoa,   8086,   .s1,    8,  10,     0b0011      ; "+8086"
    38 0000009A [F200]68961FE87F00-
    38 000000A2 83C40A             
    39 000000A5 68[F200]E8570083C4-         cdecl   puts,   .s1
    39 000000AD 02                 
    40                                  
    41 000000AE 6A016A0A6A0868-             cdecl   itoa,   -8086,  .s1,    8,  10,     0b0001      ; "-8086"
    41 000000B5 [F200]686AE0E86400-
    41 000000BD 83C40A             
    42 000000C0 68[F200]E83C0083C4-         cdecl   puts,   .s1
    42 000000C8 02                 
    43                                  
    44 000000C9 6A016A0A6A0868-             cdecl   itoa,   -1,     .s1,    8,  10,     0b0001      ; "-1"
    44 000000D0 [F200]6AFFE84A0083-
    44 000000D8 C40A               
    45 000000DA 68[F200]E8220083C4-         cdecl   puts,   .s1
    45 000000E2 02                 
    46                                  
    47                                  ;    cdecl   itoa,   -1,     .s1,    8,  10,     0b0000      ; "65535"
    48                                  ;    cdecl   puts,   .s1
    49                                  
    50                                  ;    cdecl   itoa,   -1,     .s1,    8,  16,     0b0000      ; "FFFF"
    51                                  ;    cdecl   puts,   .s1
    52                                  
    53                                  ;    cdecl   itoa,   12,     .s1,    8,  2,      0b0100      ; "00001100"
    54                                  ;    cdecl   puts,   .s1
    55                                  
    56 000000E3 EBFE                        jmp     $               ; while(1) ; ÁÑ°Èôê„É´„Éº„Éó
    57                                  
    58                                      ; „Éá„Éº„Çø
    59 000000E5 426F6F74696E672E2E-     .s0 db "Booting...", 0x0A, 0x0D, 0
    59 000000EE 2E0A0D00           
    60 000000F2 2D2D2D2D2D2D2D2D2D-     .s1 db "----------", 0x0A, 0x0D, 0
    60 000000FB 2D0A0D00           
    61                                  
    62 000000FF 00                      ALIGN 2, db 0
    63                                  BOOT:
    64 00000100 0000                    .DRIVE: dw 0
    65                                  
    66                                  ; „É¢„Ç∏„É•„Éº„É´
    67                                  %include    "../modules/real/puts.s"
     1                              <1> puts:
     2                              <1>     ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ
     3 00000102 55                  <1>     push    bp  ; bp + 4: ÊñáÂ≠óÂàó„Å∏„ÅÆ„Ç¢„Éâ„É¨„Çπ
     4 00000103 89E5                <1>     mov     bp, sp
     5                              <1> 
     6                              <1>     ; „É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò
     7 00000105 50                  <1>     push    ax
     8 00000106 53                  <1>     push    bx
     9 00000107 56                  <1>     push    si
    10                              <1> 
    11                              <1>     ; ÂºïÊï∞„ÇíÂèñÂæó
    12 00000108 8B7604              <1>     mov     si, [bp + 4]  ; ÊñáÂ≠óÂàó„Å∏„ÅÆ„Ç¢„Éâ„É¨„Çπ„Çí SI „Å´„Çª„ÉÉ„Éà„ÄÇ
    13                              <1> 
    14                              <1>     ; Âá¶ÁêÜ„ÅÆÈñãÂßã
    15 0000010B B40E                <1>     mov     ah, 0x0E
    16 0000010D BB0000              <1>     mov     bx, 0x0000
    17 00000110 FC                  <1>     cld
    18                              <1> .10L:
    19 00000111 AC                  <1>     lodsb  ; Load String. 'b' stands for byte.
    20                              <1> 
    21 00000112 3C00                <1>     cmp     al, 0
    22 00000114 7404                <1>     je      .10E
    23                              <1> 
    24 00000116 CD10                <1>     int     0x10
    25 00000118 EBF7                <1>     jmp     .10L
    26                              <1> .10E:
    27                              <1> 
    28                              <1>     ; „É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞
    29 0000011A 5E                  <1>     pop     si
    30 0000011B 5B                  <1>     pop     bx
    31 0000011C 58                  <1>     pop     ax
    32                              <1> 
    33                              <1>     ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ
    34 0000011D 89EC                <1>     mov     sp, bp
    35 0000011F 5D                  <1>     pop     bp
    36                              <1> 
    37 00000120 C3                  <1>     ret
    68                                  %include    "../modules/real/itoa.s"
     1                              <1> itoa:
     2                              <1>         ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÊßãÁØâ
     3 00000121 55                  <1>         push    bp
     4 00000122 89E5                <1>         mov     bp, sp
     5                              <1> 
     6                              <1>         ; „É¨„Ç∏„Çπ„Çø„ÅÆ‰øùÂ≠ò
     7 00000124 50                  <1>         push    ax
     8 00000125 53                  <1>         push    bx
     9 00000126 51                  <1>         push    cx
    10 00000127 52                  <1>         push    dx
    11 00000128 56                  <1>         push    si
    12 00000129 57                  <1>         push    di
    13                              <1> 
    14                              <1>         ; ÂºïÊï∞„ÇíÂèñÂæó
    15 0000012A 8B4604              <1>         mov     ax, [bp + 4]
    16 0000012D 8B7606              <1>         mov     si, [bp + 6]
    17 00000130 8B4E08              <1>         mov     cx, [bp + 8]
    18                              <1> 
    19 00000133 89F7                <1>         mov     di, si
    20 00000135 01CF                <1>         add     di, cx
    21 00000137 4F                  <1>         dec     di
    22                              <1> 
    23 00000138 8B5E0C              <1>         mov     bx, word [bp + 12]
    24                              <1> 
    25                              <1>         ; Á¨¶Âè∑‰ªò„ÅçÂà§ÂÆö
    26 0000013B F7C30100            <1>         test    bx, 0b0001
    27 0000013F 7408                <1> .10Q:   je  .10E
    28 00000141 83F800              <1>         cmp ax, 0
    29 00000144 7D03                <1> .12Q:   jge .12E
    30 00000146 83CB02              <1>         or  bx, 0b0010
    31                              <1> .12E:
    32                              <1> .10E:
    33                              <1> 
    34                              <1>         ; Á¨¶Âè∑Âá∫ÂäõÂà§ÂÆö
    35 00000149 F7C30200            <1>         test    bx, 0b0010
    36 0000014D 7410                <1> .20Q:   je  .20E
    37 0000014F 83F800              <1>         cmp ax, 0
    38 00000152 7D07                <1> .22Q:   jge .22F
    39 00000154 F7D8                <1>         neg ax
    40 00000156 C6042D              <1>         mov [si], byte  '-'
    41 00000159 EB03                <1>         jmp .22E
    42                              <1> .22F:
    43 0000015B C6042B              <1>         mov [si], byte  '+'
    44                              <1> .22E:
    45 0000015E 49                  <1>         dec cx
    46                              <1> .20E:
    47                              <1> 
    48                              <1>         ; ASCII Â§âÊèõ
    49 0000015F 8B5E0A              <1>         mov     bx, [bp + 10]
    50                              <1> .30L:
    51 00000162 BA0000              <1>         mov     dx, 0
    52 00000165 F7F3                <1>         div     bx
    53                              <1> 
    54 00000167 89D6                <1>         mov     si, dx
    55 00000169 8A94[9101]          <1>         mov     dl, byte [.ascii + si]
    56                              <1> 
    57 0000016D 8815                <1>         mov     [di], dl
    58 0000016F 4F                  <1>         dec     di
    59                              <1> 
    60 00000170 83F800              <1>         cmp     ax, 0
    61 00000173 E0ED                <1>         loopnz  .30L
    62                              <1> .30E:
    63                              <1> 
    64                              <1>         ; Á©∫Ê¨Ñ„ÇíÂüã„ÇÅ„Çã
    65 00000175 83F900              <1>         cmp     cx, 0
    66 00000178 740D                <1> .40Q:   je      .40E
    67 0000017A B020                <1>         mov     al, ' '
    68 0000017C 837E0C04            <1>         cmp     [bp +12], word 0b0100
    69 00000180 7502                <1> .42Q:   jne     .42E
    70 00000182 B030                <1>         mov     al, '0'
    71                              <1> .42E:
    72 00000184 FD                  <1>         std
    73 00000185 F3AA                <1>         rep stosb
    74                              <1> .40E:
    75                              <1> 
    76                              <1>         ; „É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞
    77 00000187 5F                  <1>         pop     di
    78 00000188 5E                  <1>         pop     si
    79 00000189 5A                  <1>         pop     dx
    80 0000018A 59                  <1>         pop     cx
    81 0000018B 5B                  <1>         pop     bx
    82 0000018C 58                  <1>         pop     ax
    83                              <1> 
    84                              <1>         ; „Çπ„Çø„ÉÉ„ÇØ„Éï„É¨„Éº„É†„ÅÆÁ†¥Ê£Ñ
    85 0000018D 89EC                <1>         mov     sp, bp
    86 0000018F 5D                  <1>         pop     bp
    87                              <1> 
    88 00000190 C3                  <1>         ret
    89                              <1> 
    90 00000191 303132333435363738- <1> .ascii  db      "0123456789ABCDEF"
    90 0000019A 39414243444546      <1>
    69                                  %include    "../modules/real/reboot.s"
     1                              <1> reboot:
     2                              <1>         ; „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
     3 000001A1 68[BD01]E85BFF83C4- <1>         cdecl   puts, .s0     ; ÂÜçËµ∑Âãï„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
     3 000001A9 02                  <1>
     4                              <1> 
     5                              <1>         ; „Ç≠„Éº„ÅÆÂÖ•ÂäõÂæÖ„Å°
     6                              <1> .10L:
     7 000001AA B410                <1>         mov     ah, 0x10
     8 000001AC CD16                <1>         int     0x16
     9                              <1> 
    10 000001AE 3C20                <1>         cmp     al, ' '
    11 000001B0 75F8                <1>         jne     .10L
    12                              <1> 
    13                              <1>         ; ÊîπË°å„ÇíÂá∫Âäõ
    14 000001B2 68[DB01]E84AFF83C4- <1>         cdecl   puts, .s1
    14 000001BA 02                  <1>
    15                              <1> 
    16                              <1>         ; ÂÜçËµ∑Âãï
    17 000001BB CD19                <1>         int     0x19
    18                              <1> 
    19                              <1>         ; ÊñáÂ≠óÂàó„Éá„Éº„Çø
    20 000001BD 0A0D50757368205350- <1> .s0     db  0x0A, 0x0D, "Push SPACE key to reboot...", 0
    20 000001C6 414345206B65792074- <1>
    20 000001CF 6F207265626F6F742E- <1>
    20 000001D8 2E2E00              <1>
    21 000001DB 0A0D0A0A00          <1> .s1     db  0x0A, 0x0D, 0x0A, 0x0A, 0
    70                                  
    71 000001E0 00<rept>                    times    510 - ($ - $$) db 0x00
    72 000001FE 55AA                        db 0x55, 0xAA
